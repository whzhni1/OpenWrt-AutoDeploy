name: ÊûÑÂª∫ VNT / VNTS

on:
  schedule:
    - cron: '0 17 * * *'
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Âº∫Âà∂ÈáçÊñ∞ÊûÑÂª∫'
        type: boolean
        default: false

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.check.outputs.matrix }}
      has_updates: ${{ steps.check.outputs.has_updates }}
      defaults: ${{ steps.check.outputs.defaults }}
    steps:
      - uses: actions/checkout@v4
      - id: check
        run: |
          wget -qO /tmp/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 && chmod +x /tmp/yq
          echo "defaults=$(/tmp/yq '.defaults' config/sync-config.yaml -o=json -I=0)" >> $GITHUB_OUTPUT
          
          UPDATES='[]'
          for name in vnt vnts; do
            ver=$(curl -s "https://api.github.com/repos/vnt-dev/$name/releases/latest" | jq -r '.tag_name|ltrimstr("v")')
            [ -z "$ver" ] && continue
            local=$(bash .github/workflows/scripts/version-manager.sh read "$name" 2>/dev/null || echo "")
            if [ "$local" != "$ver" ] || [ "${{ inputs.force_build }}" = "true" ]; then
              UPDATES=$(echo "$UPDATES" | jq -c --arg n "$name" --arg v "$ver" '. += [{name:$n,version:$v,luci:($n=="vnt")}]')
            fi
          done
          
          [ "$UPDATES" = "[]" ] && echo "has_updates=false" >> $GITHUB_OUTPUT || echo "has_updates=true" >> $GITHUB_OUTPUT
          echo "matrix={\"include\":$UPDATES}" >> $GITHUB_OUTPUT

  build:
    needs: check
    if: needs.check.outputs.has_updates == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.check.outputs.matrix) }}
    steps:
      - name: ÊûÑÂª∫ ${{ matrix.name }}
        run: |
          set -e
          NAME="${{ matrix.name }}"
          VER="${{ matrix.version }}"
          mkdir -p out

          # Êû∂ÊûÑÊò†Â∞ÑÂáΩÊï∞
          targets() {
            case $1 in
              aarch64) echo aarch64_cortex-a53 aarch64_cortex-a72 aarch64_cortex-a76 aarch64_generic;;
              arm)     echo arm_arm1176jzf-s_vfp arm_fa526 arm_mpcore arm_xscale;;
              armv7)   echo arm_cortex-a5_vfpv4 arm_cortex-a7 arm_cortex-a7_neon-vfpv4 arm_cortex-a7_vfpv4 arm_cortex-a8_vfpv3 arm_cortex-a9 arm_cortex-a9_neon arm_cortex-a9_vfpv3-d16 arm_cortex-a15_neon-vfpv4;;
              x86_64)  echo x86_64;;
              i686)    echo i386_pentium-mmx i386_pentium4;;
              mips)    echo mips_24kc mips_mips32;;
              mipsel)  echo mipsel_24kc mipsel_24kc_24kf mipsel_74kc mipsel_mips32;;
            esac
          }

          # ÈÄöÁî®ÊâìÂåÖÂáΩÊï∞
          mkpkg() {
            local pkg="$1" ver="$2" arch="$3" dir="$4" deps="$5"
            local size=$(du -sb "$dir" | cut -f1)
            
            # ÁîüÊàê control
            mkdir -p "$dir/CONTROL"
            printf 'Package: %s\nVersion: %s\nArchitecture: %s\nInstalled-Size: %s\nDescription: %s for OpenWrt\n' \
              "$pkg" "$ver" "$arch" "$size" "$pkg" > "$dir/CONTROL/control"
            [ -n "$deps" ] && echo "Depends: $deps" >> "$dir/CONTROL/control"
            
            # ÊâìÂåÖ IPK
            echo '2.0' > debian-binary
            tar --format=gnu --numeric-owner --group=0 --owner=0 -czf control.tar.gz -C "$dir/CONTROL" .
            local data_dirs=$(find "$dir" -maxdepth 1 -type d ! -name CONTROL ! -name "$(basename $dir)" -printf './%f ')
            tar --format=gnu --numeric-owner --group=0 --owner=0 -czf data.tar.gz -C "$dir" $data_dirs
            tar --format=gnu --numeric-owner --group=0 --owner=0 -czf "out/${pkg}_${ver}_${arch}.ipk" ./control.tar.gz ./data.tar.gz ./debian-binary
            
            # ÊâìÂåÖ APK
            printf 'pkgname = %s\npkgver = %s\npkgdesc = %s for OpenWrt\narch = %s\nsize = %s\n' \
              "$pkg" "$ver" "$pkg" "$arch" "$size" > "$dir/.PKGINFO"
            [ -n "$deps" ] && echo "depend = $deps" >> "$dir/.PKGINFO"
            rm -rf "$dir/CONTROL"
            tar -czf "out/${pkg}-${ver}.${arch}.apk" -C "$dir" .
            
            rm -f control.tar.gz data.tar.gz debian-binary
          }

          # ‰∏ãËΩΩÂπ∂ÊâìÂåÖ‰∫åËøõÂà∂
          for asset in $(curl -s "https://api.github.com/repos/vnt-dev/$NAME/releases/latest" | jq -r '.assets[].name'); do
            case $asset in *-unknown-linux-musl*.tar.gz) ;; *) continue;; esac
            arch=$(echo "$asset" | cut -d- -f2)
            tgts=$(targets "$arch")
            [ -z "$tgts" ] && continue
            
            echo "üì¶ $asset"
            wget -q "https://github.com/vnt-dev/$NAME/releases/download/v$VER/$asset" -O dl.tar.gz || continue
            rm -rf bin && mkdir bin && tar -xf dl.tar.gz -C bin
            
            for t in $tgts; do
              rm -rf pkg && mkdir -p pkg/usr/bin
              find bin -type f -exec cp {} pkg/usr/bin/ \;
              chmod +x pkg/usr/bin/*
              mkpkg "$NAME" "$VER" "$t" "pkg" ""
              echo "  ‚úÖ $t"
            done
            rm -rf bin dl.tar.gz
          done

          # ÊâìÂåÖ LuCI
          if [ "${{ matrix.luci }}" = "true" ]; then
            echo "üì¶ luci-app-vnt"
            git clone --depth=1 https://github.com/lmq8267/luci-app-vnt src
            luci_ver=$(grep -oP 'PKG_VERSION:=\K.*' src/luci-app-vnt/Makefile | head -1)
            
            rm -rf pkg && mkdir -p pkg
            [ -d src/luci-app-vnt/luasrc ] && mkdir -p pkg/usr/lib/lua/luci && cp -R src/luci-app-vnt/luasrc/* pkg/usr/lib/lua/luci/
            [ -d src/luci-app-vnt/htdocs ] && mkdir -p pkg/www && cp -R src/luci-app-vnt/htdocs/* pkg/www/
            [ -d src/luci-app-vnt/root ] && cp -R src/luci-app-vnt/root/* pkg/
            
            mkpkg "luci-app-vnt" "$luci_ver" "all" "pkg" "vnt"
            echo "  ‚úÖ luci-app-vnt"
            rm -rf src
          fi

          rm -rf pkg
          echo "üì¶ ÂÖ± $(ls out | wc -l) ‰∏™ÂåÖ"
          ls -lh out/

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: out/*
          retention-days: 3

  release:
    needs: [check, build]
    if: needs.check.outputs.has_updates == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.check.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: files

      - name: ÂèëÂ∏É
        env:
          USERNAME: ${{ fromJSON(needs.check.outputs.defaults).username }}
          PLATFORMS: ${{ fromJSON(needs.check.outputs.defaults).platforms }}
          R2_PUBLIC_URL: ${{ fromJSON(needs.check.outputs.defaults).R2_PUBLIC_URL }}
          GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
          R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
          REPO_NAME: ${{ matrix.name }}
          TAG_NAME: ${{ matrix.version }}
          DOWNLOAD_DIR: files
          GITHUB_REPO_URL: https://github.com/vnt-dev/${{ matrix.name }}
        run: |
          export UPLOAD_FILES="$(find files -type f | tr '\n' ' ')"
          export RELEASE_BODY="## üì¶ ${{ matrix.name }} ${{ matrix.version }}"
          bash .github/workflows/scripts/release.sh

      - name: Êõ¥Êñ∞ÁâàÊú¨
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          bash .github/workflows/scripts/version-manager.sh write "${{ matrix.name }}" "${{ matrix.version }}"
          git add config/version.txt
          git diff --cached --quiet || git commit -m "Êõ¥Êñ∞ ${{ matrix.name }} ‚Üí ${{ matrix.version }}"
          git push || git pull --rebase && git push
