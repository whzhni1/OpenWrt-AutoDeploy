name: æ„å»º VNT / VNTS / LuCI

on:
  schedule:
    - cron: '0 17 * * *'
  workflow_dispatch:
    inputs:
      force_build:
        description: 'å¼ºåˆ¶é‡æ–°æ„å»º'
        type: boolean
        default: false

jobs:
  check-updates:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.value }}
      has_updates: ${{ steps.matrix.outputs.has_updates }}
      defaults: ${{ steps.read-config.outputs.defaults }}
      vnt_version: ${{ steps.matrix.outputs.vnt_version }}

    steps:
      - uses: actions/checkout@v4

      - name: è¯»å–é…ç½®
        id: read-config
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          defaults=$(yq eval '.defaults' config/sync-config.yaml -o=json -I=0)
          echo "defaults=$defaults" >> $GITHUB_OUTPUT

      - name: æ£€æŸ¥ VNT / VNTS ä¸Šæ¸¸ç‰ˆæœ¬
        id: matrix
        run: |
          PROJECTS='[
            {"github_owner":"vnt-dev","github_repo":"vnt","local_name":"vnt"},
            {"github_owner":"vnt-dev","github_repo":"vnts","local_name":"vnts"}
          ]'

          UPDATES='[]'
          VNT_VER=""

          while read -r proj; do
            owner=$(echo "$proj" | jq -r '.github_owner')
            repo=$(echo "$proj" | jq -r '.github_repo')
            name=$(echo "$proj" | jq -r '.local_name')

            latest=$(curl -s "https://api.github.com/repos/$owner/$repo/releases/latest" | jq -r '.tag_name // empty')
            latest=${latest#v}

            [ -z "$latest" ] && continue

            local=$(bash .github/workflows/scripts/version-manager.sh read "$name" 2>/dev/null || echo "")

            if [ -z "$local" ] || [ "$local" != "$latest" ] || [ "${{ inputs.force_build }}" = "true" ]; then
              UPDATES=$(echo "$UPDATES" | jq -c \
                --arg o "$owner" --arg r "$repo" --arg n "$name" --arg v "$latest" \
                '. += [{github_owner:$o, github_repo:$r, local_name:$n, version:$v}]')

              if [ "$name" = "vnt" ]; then
                VNT_VER="$latest"
              fi
            fi
          done < <(echo "$PROJECTS" | jq -c '.[]')

          if [ "$UPDATES" = "[]" ]; then
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo 'value={"include":[]}' >> $GITHUB_OUTPUT
          else
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "value={\"include\":$UPDATES}" >> $GITHUB_OUTPUT
          fi

          echo "vnt_version=$VNT_VER" >> $GITHUB_OUTPUT

  build-binary:
    name: æ‰“åŒ…äºŒè¿›åˆ¶ ${{ matrix.project.local_name }}
    runs-on: ubuntu-latest
    needs: check-updates
    if: needs.check-updates.outputs.has_updates == 'true'

    strategy:
      fail-fast: false
      matrix:
        project: ${{ fromJson(needs.check-updates.outputs.matrix).include }}

    steps:
      - uses: actions/checkout@v4

      - name: è·å–ä¸Šæ¸¸ assets åˆ—è¡¨
        id: assets
        run: |
          ASSETS=$(curl -s "https://api.github.com/repos/${{ matrix.project.github_owner }}/${{ matrix.project.github_repo }}/releases/latest" \
            | jq -r '.assets[].name')
          echo "assets<<EOF" >> $GITHUB_OUTPUT
          echo "$ASSETS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: è‡ªåŠ¨æ‰“åŒ… VNT/VNTS IPK / APKï¼ˆåŠ¨æ€æ¶æ„ï¼‰
        env:
          ASSETS: ${{ steps.assets.outputs.assets }}
        run: |
          set -e
          mkdir -p output

          VERSION="${{ matrix.project.version }}"
          NAME="${{ matrix.project.local_name }}"

          # ä¸Šæ¸¸æ¶æ„ â†’ OpenWrt æ¶æ„æ˜ å°„
          get_targets() {
            case "$1" in
              aarch64) echo "aarch64_cortex-a53 aarch64_cortex-a72 aarch64_cortex-a76 aarch64_generic" ;;
              armv7)   echo "arm_arm1176jzf-s_vfp arm_cortex-a5_vfpv4 arm_cortex-a7 arm_cortex-a7_neon-vfpv4 arm_cortex-a7_vfpv4 arm_cortex-a8_vfpv3 arm_cortex-a9 arm_cortex-a9_neon arm_cortex-a9_vfpv3-d16 arm_cortex-a15_neon-vfpv4 arm_fa526 arm_mpcore arm_xscale" ;;
              x86_64)  echo "x86_64" ;;
              i686)    echo "i386_pentium-mmx i386_pentium4" ;;
              mips)    echo "mips_24kc mips_mips32" ;;
              mipsel)  echo "mipsel_24kc mipsel_24kc_24kf mipsel_74kc mipsel_mips32" ;;
              *) echo "" ;;
            esac
          }

          echo "$ASSETS" | while IFS= read -r asset; do
            [ -z "$asset" ] && continue
            
            case "$asset" in
              *unknown-linux-musl*.tar.gz)
                UPSTREAM_ARCH=$(echo "$asset" | sed -E 's/.*[-_]([a-z0-9_]+)-unknown-linux-musl.*\.tar\.gz/\1/')
                ;;
              *)
                continue
                ;;
            esac

            TARGETS=$(get_targets "$UPSTREAM_ARCH")
            [ -z "$TARGETS" ] && { echo "è·³è¿‡æœªçŸ¥æ¶æ„: $UPSTREAM_ARCH"; continue; }

            echo "å¤„ç†: $asset â†’ $TARGETS"

            URL="https://github.com/${{ matrix.project.github_owner }}/${{ matrix.project.github_repo }}/releases/download/v${VERSION}/${asset}"
            wget -q "$URL" -O bin.tar.gz || { echo "ä¸‹è½½å¤±è´¥"; continue; }

            mkdir -p tmp_bin
            tar -xf bin.tar.gz -C tmp_bin

            for TARGET in $TARGETS; do
              mkdir -p pkg/usr/bin pkg/CONTROL

              find tmp_bin -type f -exec cp {} pkg/usr/bin/ \;
              chmod +x pkg/usr/bin/*

              cat > pkg/CONTROL/control <<EOF
          Package: $NAME
          Version: $VERSION
          Architecture: $TARGET
          Description: $NAME binary package (repacked)
          Section: net
          Priority: optional
          Maintainer: Automated Build <https://github.com/${{ github.repository }}>
          Source: https://github.com/${{ matrix.project.github_owner }}/${{ matrix.project.github_repo }}
          EOF

              echo '2.0' > debian-binary
              tar --format=gnu --numeric-owner --group=0 --owner=0 -czf control.tar.gz -C pkg/CONTROL .
              tar --format=gnu --numeric-owner --group=0 --owner=0 -czf data.tar.gz -C pkg usr

              ar r "output/${NAME}_${VERSION}_${TARGET}.ipk" debian-binary control.tar.gz data.tar.gz
              tar --format=gnu --numeric-owner --group=0 --owner=0 -czf "output/${NAME}-${VERSION}.${TARGET}.apk" -C pkg .

              echo "âœ… ${NAME}_${VERSION}_${TARGET}.ipk"
              rm -rf pkg control.tar.gz data.tar.gz debian-binary
            done

            rm -rf tmp_bin bin.tar.gz
          done

          echo "ğŸ“¦ ç”Ÿæˆçš„åŒ…:"
          ls -1 output/

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.project.local_name }}-bin
          path: output/*
          if-no-files-found: error
          retention-days: 3

  build-luci:
    name: æ‰“åŒ… LuCI
    runs-on: ubuntu-latest
    needs: check-updates
    if: needs.check-updates.outputs.vnt_version != ''
    steps:
      - uses: actions/checkout@v4

      - name: å…‹éš† luci-app-vnt æºç 
        run: |
          git clone https://github.com/lmq8267/luci-app-vnt luci-app-vnt

      - name: è¯»å– LuCI PKG_VERSION
        id: luci_ver
        run: |
          MAKEFILE="luci-app-vnt/luci-app-vnt/Makefile"
          PKG_VERSION=$(grep -E '^PKG_VERSION[:=]' "$MAKEFILE" | head -n1 | sed -E 's/.*[:=]\s*//')
          echo "version=$PKG_VERSION" >> $GITHUB_OUTPUT
          echo "LuCI ç‰ˆæœ¬å·: $PKG_VERSION"

      - name: æ‰“åŒ… luci-app-vnt ä¸º IPK / APK
        run: |
          set -e
          VERSION="${{ steps.luci_ver.outputs.version }}"
          NAME="luci-app-vnt"
          mkdir -p pkg/CONTROL
          mkdir -p pkg/usr/lib/lua/luci
          mkdir -p pkg/www
          mkdir -p output
          if [ -d "luci-app-vnt/luci-app-vnt/luasrc" ]; then
            cp -R luci-app-vnt/luci-app-vnt/luasrc/* pkg/usr/lib/lua/luci/
          fi
          if [ -d "luci-app-vnt/luci-app-vnt/htdocs" ]; then
            cp -R luci-app-vnt/luci-app-vnt/htdocs/* pkg/www/
          fi
          if [ -d "luci-app-vnt/luci-app-vnt/root" ]; then
            cp -R luci-app-vnt/luci-app-vnt/root/* pkg/
          fi
          cat > pkg/CONTROL/control <<EOF
          Package: $NAME
          Version: $VERSION
          Architecture: all
          Description: LuCI support for VNT (Virtual Network Tunnel)
          Section: luci
          Priority: optional
          Maintainer: Automated Build <https://github.com/${{ github.repository }}>
          Source: https://github.com/lmq8267/luci-app-vnt
          EOF

          echo '2.0' > debian-binary

          tar --format=gnu --numeric-owner --group=0 --owner=0 -czf control.tar.gz -C pkg/CONTROL .
          tar --format=gnu --numeric-owner --group=0 --owner=0 -czf data.tar.gz -C pkg .

          ar r "output/${NAME}_${VERSION}_all.ipk" control.tar.gz data.tar.gz debian-binary

          tar --format=gnu --numeric-owner --group=0 --owner=0 -czf "output/${NAME}-${VERSION}.all.apk" -C pkg .

          rm -rf pkg control.tar.gz data.tar.gz debian-binary

      - uses: actions/upload-artifact@v4
        with:
          name: luci-app-vnt
          path: output/*
          if-no-files-found: error
          retention-days: 3


  release:
    name: å¤šå¹³å°å‘å¸ƒ ${{ matrix.project.local_name }}
    runs-on: ubuntu-latest
    needs: [check-updates, build-binary, build-luci]
    if: needs.check-updates.outputs.has_updates == 'true'

    strategy:
      fail-fast: false
      matrix:
        project: ${{ fromJson(needs.check-updates.outputs.matrix).include }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          path: ${{ runner.temp }}/artifacts
          merge-multiple: false

      - name: æ•´ç†å‘å¸ƒæ–‡ä»¶
        run: |
          RELEASE_DIR="${{ runner.temp }}/release/${{ matrix.project.local_name }}"
          mkdir -p "$RELEASE_DIR"
          find "${{ runner.temp }}/artifacts" -type f \
            \( -name "${{ matrix.project.local_name }}_*.ipk" -o -name "${{ matrix.project.local_name }}-*.apk" \) \
            -exec cp {} "$RELEASE_DIR/" \;
          if [ "${{ matrix.project.local_name }}" = "vnt" ]; then
            find "${{ runner.temp }}/artifacts" -type f \
              \( -name "luci-app-vnt_*.ipk" -o -name "luci-app-vnt-*.apk" \) \
              -exec cp {} "$RELEASE_DIR/" \;
          fi

          echo "RELEASE_DIR=$RELEASE_DIR" >> $GITHUB_ENV
          echo "ğŸ“¦ æ”¶é›†åˆ°çš„æ–‡ä»¶:"
          ls -lh "$RELEASE_DIR" || true

      - name: å¤šå¹³å°å‘å¸ƒï¼ˆOpenList release.shï¼‰
        env:
          USERNAME: ${{ fromJSON(needs.check-updates.outputs.defaults).username }}
          PLATFORMS: ${{ fromJSON(needs.check-updates.outputs.defaults).platforms }}
          R2_PUBLIC_URL: ${{ fromJSON(needs.check-updates.outputs.defaults).R2_PUBLIC_URL }}

          GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
          R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}

          REPO_NAME: ${{ matrix.project.local_name }}
          TAG_NAME: ${{ matrix.project.version }}
          DOWNLOAD_DIR: ${{ env.RELEASE_DIR }}
          GITHUB_REPO_URL: "https://github.com/${{ matrix.project.github_owner }}/${{ matrix.project.github_repo }}"
        run: |
          set -e
          export UPLOAD_FILES="$(find "$DOWNLOAD_DIR" -type f \( -name '*.ipk' -o -name '*.apk' \) | tr '\n' ' ')"
          export RELEASE_BODY="## ğŸ“¦ ${{ matrix.project.local_name }} ${{ matrix.project.version }} è‡ªåŠ¨æ„å»º
          - æºä»“åº“: $GITHUB_REPO_URL
          - æ„å»ºä»“åº“: https://github.com/${{ github.repository }}"
          bash .github/workflows/scripts/release.sh

      - name: æ›´æ–°ç‰ˆæœ¬è®°å½•
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          bash .github/workflows/scripts/version-manager.sh write "${{ matrix.project.local_name }}" "${{ matrix.project.version }}"
          git add config/version.txt
          git commit -m "æ›´æ–°ç‰ˆæœ¬ ${{ matrix.project.local_name }} â†’ ${{ matrix.project.version }}" || true
          git push || true
