name: ÊûÑÂª∫ VNT / VNTS

on:
  schedule:
    - cron: '0 17 * * *'
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Âº∫Âà∂ÈáçÊñ∞ÊûÑÂª∫'
        type: boolean
        default: false

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.check.outputs.matrix }}
      has_updates: ${{ steps.check.outputs.has_updates }}
      defaults: ${{ steps.check.outputs.defaults }}
    steps:
      - uses: actions/checkout@v4
      - id: check
        run: |
          # ËØªÂèñÈÖçÁΩÆ
          wget -qO /tmp/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 && chmod +x /tmp/yq
          echo "defaults=$(/tmp/yq '.defaults' config/sync-config.yaml -o=json -I=0)" >> $GITHUB_OUTPUT
          
          # Ê£ÄÊü•Êõ¥Êñ∞
          UPDATES='[]'
          for name in vnt vnts; do
            ver=$(curl -s "https://api.github.com/repos/vnt-dev/$name/releases/latest" | jq -r '.tag_name|ltrimstr("v")')
            [ -z "$ver" ] && continue
            local=$(bash .github/workflows/scripts/version-manager.sh read "$name" 2>/dev/null || echo "")
            if [ "$local" != "$ver" ] || [ "${{ inputs.force_build }}" = "true" ]; then
              UPDATES=$(echo "$UPDATES" | jq -c --arg n "$name" --arg v "$ver" '. += [{name:$n,version:$v,luci:($n=="vnt")}]')
            fi
          done
          
          [ "$UPDATES" = "[]" ] && echo "has_updates=false" >> $GITHUB_OUTPUT || echo "has_updates=true" >> $GITHUB_OUTPUT
          echo "matrix={\"include\":$UPDATES}" >> $GITHUB_OUTPUT

  build:
    needs: check
    if: needs.check.outputs.has_updates == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.check.outputs.matrix) }}
    steps:
      - name: ÊûÑÂª∫ ${{ matrix.name }}
        run: |
          set -e
          NAME="${{ matrix.name }}"
          VER="${{ matrix.version }}"
          mkdir -p out

          # Êû∂ÊûÑÊò†Â∞Ñ
          targets() {
            case $1 in
              aarch64) echo aarch64_cortex-a53 aarch64_cortex-a72 aarch64_cortex-a76 aarch64_generic;;
              arm)     echo arm_arm1176jzf-s_vfp arm_fa526 arm_mpcore arm_xscale;;
              armv7)   echo arm_cortex-a5_vfpv4 arm_cortex-a7 arm_cortex-a7_neon-vfpv4 arm_cortex-a7_vfpv4 arm_cortex-a8_vfpv3 arm_cortex-a9 arm_cortex-a9_neon arm_cortex-a9_vfpv3-d16 arm_cortex-a15_neon-vfpv4;;
              x86_64)  echo x86_64;;
              i686)    echo i386_pentium-mmx i386_pentium4;;
              mips)    echo mips_24kc mips_mips32;;
              mipsel)  echo mipsel_24kc mipsel_24kc_24kf mipsel_74kc mipsel_mips32;;
            esac
          }

          # IPK ÊâìÂåÖÂáΩÊï∞
          mkipk() {
            local pkg=$1 ver=$2 arch=$3 datadir=$4
            mkdir -p _ipk
            echo "2.0" > _ipk/debian-binary
            printf 'Package: %s\nVersion: %s\nArchitecture: %s\nDescription: %s for OpenWrt\n' "$pkg" "$ver" "$arch" "$pkg" > _ipk/control
            tar -czf _ipk/control.tar.gz -C _ipk control && rm _ipk/control
            tar -czf _ipk/data.tar.gz -C "$datadir" .
            ar -r "out/${pkg}_${ver}_${arch}.ipk" _ipk/debian-binary _ipk/control.tar.gz _ipk/data.tar.gz
            rm -rf _ipk
          }

          # ‰∏ãËΩΩÂπ∂ÊâìÂåÖ‰∫åËøõÂà∂
          for asset in $(curl -s "https://api.github.com/repos/vnt-dev/$NAME/releases/latest" | jq -r '.assets[].name'); do
            case $asset in *-unknown-linux-musl*.tar.gz) ;; *) continue;; esac
            arch=$(echo "$asset" | cut -d- -f2)
            tgts=$(targets "$arch")
            [ -z "$tgts" ] && continue
            
            wget -q "https://github.com/vnt-dev/$NAME/releases/download/v$VER/$asset" -O dl.tar.gz || continue
            mkdir -p bin && tar -xf dl.tar.gz -C bin
            
            for t in $tgts; do
              mkdir -p data/usr/bin
              find bin -type f -exec cp {} data/usr/bin/ \;
              chmod +x data/usr/bin/*
              mkipk "$NAME" "$VER" "$t" data
              rm -rf data
            done
            rm -rf bin dl.tar.gz
          done

          # ÊâìÂåÖ LuCIÔºà‰ªÖ vntÔºâ
          if [ "${{ matrix.luci }}" = "true" ]; then
            git clone --depth=1 https://github.com/lmq8267/luci-app-vnt src
            luci_ver=$(grep -oP 'PKG_VERSION:=\K.*' src/luci-app-vnt/Makefile | head -1)
            mkdir -p data
            [ -d src/luci-app-vnt/luasrc ] && mkdir -p data/usr/lib/lua/luci && cp -R src/luci-app-vnt/luasrc/* data/usr/lib/lua/luci/
            [ -d src/luci-app-vnt/htdocs ] && mkdir -p data/www && cp -R src/luci-app-vnt/htdocs/* data/www/
            [ -d src/luci-app-vnt/root ] && cp -R src/luci-app-vnt/root/* data/
            mkipk luci-app-vnt "$luci_ver" all data
            rm -rf src data
          fi

          echo "üì¶ ÁîüÊàê $(ls out/*.ipk | wc -l) ‰∏™ÂåÖ"
          ls -lh out/

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: out/*
          retention-days: 3

  release:
    needs: [check, build]
    if: needs.check.outputs.has_updates == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.check.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: files

      - name: ÂèëÂ∏É
        env:
          USERNAME: ${{ fromJSON(needs.check.outputs.defaults).username }}
          PLATFORMS: ${{ fromJSON(needs.check.outputs.defaults).platforms }}
          R2_PUBLIC_URL: ${{ fromJSON(needs.check.outputs.defaults).R2_PUBLIC_URL }}
          GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
          R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
          REPO_NAME: ${{ matrix.name }}
          TAG_NAME: ${{ matrix.version }}
          DOWNLOAD_DIR: files
          GITHUB_REPO_URL: https://github.com/vnt-dev/${{ matrix.name }}
        run: |
          export UPLOAD_FILES="$(find files -type f | tr '\n' ' ')"
          export RELEASE_BODY="## üì¶ ${{ matrix.name }} ${{ matrix.version }}"
          bash .github/workflows/scripts/release.sh

      - name: Êõ¥Êñ∞ÁâàÊú¨
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          bash .github/workflows/scripts/version-manager.sh write "${{ matrix.name }}" "${{ matrix.version }}"
          git add config/version.txt
          git diff --cached --quiet || git commit -m "Êõ¥Êñ∞ ${{ matrix.name }} ‚Üí ${{ matrix.version }}"
          git push || git pull --rebase && git push
