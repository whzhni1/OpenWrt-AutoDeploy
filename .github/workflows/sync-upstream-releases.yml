name: åŒæ­¥ä¸Šæ¸¸å‘å¸ƒæ’ä»¶

on:
  schedule:
    - cron: '0 17 * * *'
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'å¼ºåˆ¶åŒæ­¥'
        type: boolean
        default: false

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      
      - name: è¯»å–åŒæ­¥é…ç½®
        id: set-matrix
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          
          matrix=$(yq eval '.repositories' sync-config.yaml -o=json -I=0)
          echo "matrix={\"include\":$matrix}" >> $GITHUB_OUTPUT
          
          echo "ðŸ“‹ è¯»å–åˆ° $(echo $matrix | jq '. | length') ä¸ªä»“åº“é…ç½®"
          echo "$matrix" | jq -r '.[] | "  - \(.github_owner)/\(.github_repo)"'

  sync:
    needs: prepare
    name: ${{ matrix.github_repo }}
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJSON(needs.prepare.outputs.matrix) }}
      fail-fast: false
      max-parallel: 3
      
    steps:
      - uses: actions/checkout@v4
      
      - name: æ£€æŸ¥æ›´æ–°
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          local_name="${{ matrix.local_name || matrix.github_repo }}"
          repo="${{ matrix.github_owner }}/${{ matrix.github_repo }}"
          
          # èŽ·å–æœ€æ–° tag
          tag=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/$repo/tags?per_page=1" | jq -r '.[0].name // empty')
          
          if [ -z "$tag" ]; then
            echo "needs_update=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # èŽ·å– Release
          release=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/$repo/releases/tags/$tag")
          
          if ! echo "$release" | jq -e '.assets[0]' >/dev/null 2>&1; then
            release=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/$repo/releases/latest")
            tag=$(echo "$release" | jq -r '.tag_name')
          fi
          
          [ $(echo "$release" | jq '.assets | length') -eq 0 ] && exit 0
          
          echo "$release" > /tmp/release.json
          [[ "$tag" =~ ^v ]] && version="$tag" || version="v$tag"
          
          # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
          local=$(bash .github/workflows/scripts/version-manager.sh read "$local_name" 2>/dev/null || echo "")
          
          if [ -z "$local" ] || [ "$local" != "$version" ] || [ "${{ inputs.force_sync }}" = "true" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "âœ… $local_name: ${local:-æ–°å»º} â†’ $version"
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  $local_name: å·²æ˜¯æœ€æ–° ($version)"
          fi
          
          echo "local_name=$local_name" >> $GITHUB_OUTPUT
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "local_version=${local:-æ–°å»º}" >> $GITHUB_OUTPUT
      
      - name: ä¸‹è½½å¹¶è¿‡æ»¤æ–‡ä»¶
        id: download
        if: steps.check.outputs.needs_update == 'true'
        run: |
          DOWNLOAD_DIR="${{ runner.temp }}/downloads"
          mkdir -p "$DOWNLOAD_DIR"
          
          # ä¸‹è½½æ‰€æœ‰æ–‡ä»¶
          cat /tmp/release.json | jq -r '.assets[] | "\(.browser_download_url)|\(.name)"' | \
          while IFS='|' read -r url filename; do
            [ -n "$url" ] && curl -sL "$url" -o "$DOWNLOAD_DIR/$filename" && echo "âœ“ $filename"
          done
          
          cd "$DOWNLOAD_DIR"
          VERSION="${{ steps.check.outputs.version }}"
          VERSION_NO_V="${VERSION#v}"
          
          # åº”ç”¨è¿‡æ»¤è§„åˆ™
          if [ -n "${{ matrix.filter_include }}" ]; then
            temp=$(mktemp -d)
            declare -A count limit
            
            for rule in ${{ matrix.filter_include }}; do
              pattern="${rule%:*}"
              pattern="${pattern//\{VERSION\}/$VERSION_NO_V}"
              lim="${rule##*:}"
              [ "$lim" = "$rule" ] && lim=999
              limit["$pattern"]=$lim
              count["$pattern"]=0
              
              for file in $pattern; do
                [ ! -f "$file" ] && continue
                [ ${count["$pattern"]} -ge ${limit["$pattern"]} ] && break
                mv "$file" "$temp/" && count["$pattern"]=$((${count["$pattern"]} + 1))
              done
            done
            
            rm -rf * && mv "$temp"/* . && rm -rf "$temp"
            
          elif [ -n "${{ matrix.filter_exclude }}" ]; then
            for pattern in ${{ matrix.filter_exclude }}; do
              rm -f $pattern 2>/dev/null
            done
          fi
          
          [ "${{ matrix.filter_by_version }}" = "true" ] && find . -type f ! -name "*$VERSION_NO_V*" -delete
          
          echo "DOWNLOAD_DIR=$DOWNLOAD_DIR" >> $GITHUB_ENV
          echo "ðŸ“¦ æ–‡ä»¶: $(find . -type f | wc -l) ä¸ª"
      
      - name: å¹¶è¡Œå‘å¸ƒ
        id: release
        if: steps.check.outputs.needs_update == 'true'
        env:
          PLATFORMS: ${{ matrix.platforms || 'gitcode gitee gitlab r2' }}
          GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
          R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
          
          REPO_NAME: ${{ steps.check.outputs.local_name }}
          TAG_NAME: ${{ steps.check.outputs.version }}
          DOWNLOAD_DIR: ${{ env.DOWNLOAD_DIR }}
          GITHUB_REPO_URL: "https://github.com/${{ matrix.github_owner }}/${{ matrix.github_repo }}"
        run: bash .github/workflows/scripts/release.sh
      
      - name: ä¿å­˜ç‰ˆæœ¬ä¿¡æ¯
        if: steps.check.outputs.needs_update == 'true' && steps.release.outcome == 'success'
        run: |
          mkdir -p /tmp/version
          echo "${{ steps.check.outputs.local_name }}|${{ steps.check.outputs.version }}" > /tmp/version/update.txt
      
      - uses: actions/upload-artifact@v4
        if: steps.check.outputs.needs_update == 'true' && steps.release.outcome == 'success'
        with:
          name: version-${{ matrix.github_repo }}
          path: /tmp/version/update.txt
          retention-days: 1
      
      - name: ç”ŸæˆçŠ¶æ€
        if: always()
        run: |
          mkdir -p /tmp/status
          
          # âœ… ä¿®æ­£åˆ¤æ–­é€»è¾‘
          if [ "${{ steps.check.outputs.needs_update }}" != "true" ]; then
            status="âœ… æ— éœ€æ›´æ–°"
          elif [ "${{ steps.release.outcome }}" = "success" ]; then
            status="âœ… å·²å‘å¸ƒ"
          else
            status="âŒ å¤±è´¥"
          fi
          
          cat > "/tmp/status/${{ matrix.github_repo }}.txt" <<EOF
          ${{ matrix.github_repo }}
          ${{ steps.check.outputs.local_name }}
          ${{ steps.check.outputs.version }}
          ${{ steps.check.outputs.local_version }}
          $status
          EOF
      
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: status-${{ matrix.github_repo }}
          path: /tmp/status/${{ matrix.github_repo }}.txt
          retention-days: 1

  summary:
    needs: sync
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/download-artifact@v4
        with:
          pattern: version-*
          path: /tmp/versions
        continue-on-error: true
      
      - uses: actions/download-artifact@v4
        with:
          pattern: status-*
          path: /tmp/status
      
      - name: æ›´æ–°ç‰ˆæœ¬è®°å½•
        run: |
          updated=0
          for file in /tmp/versions/version-*/update.txt; do
            [ -f "$file" ] || continue
            IFS='|' read -r name version < "$file"
            [ -n "$name" ] && [ -n "$version" ] && {
              bash .github/workflows/scripts/version-manager.sh write "$name" "$version"
              echo "  âœ“ $name â†’ $version"
              updated=$((updated + 1))
            }
          done
          
          [ $updated -gt 0 ] && echo "need_push=true" >> $GITHUB_ENV || echo "â„¹ï¸  æ— éœ€æ›´æ–°"
      
      - name: æŽ¨é€ç‰ˆæœ¬è®°å½•
        if: env.need_push == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add version.txt
          git diff --cached --quiet || {
            git commit -m "ðŸ“ æ‰¹é‡æ›´æ–°ç‰ˆæœ¬è®°å½•"
            git pull --rebase origin ${{ github.ref_name }} || git push --force-with-lease
            git push origin ${{ github.ref_name }}
          }
      
      - name: ç”ŸæˆæŠ¥å‘Š
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<'EOF'
          # ðŸ“‹ ä¸Šæ¸¸åŒæ­¥æŠ¥å‘Š
          
          | ä¸Šæ¸¸é¡¹ç›® | ä»“åº“åç§° | ä¸Šæ¸¸ç‰ˆæœ¬ | æœ¬åœ°ç‰ˆæœ¬ | çŠ¶æ€ |
          |---------|---------|---------|---------|------|
          EOF
          
          total=0 updated=0 skipped=0 failed=0
          for file in /tmp/status/status-*/*.txt; do
            [ -f "$file" ] || continue
            repo=$(sed -n '1p' "$file")
            local=$(sed -n '2p' "$file")
            upstream=$(sed -n '3p' "$file")
            local_ver=$(sed -n '4p' "$file")
            status=$(sed -n '5p' "$file")
            
            echo "| $repo | $local | $upstream | $local_ver | $status |" >> $GITHUB_STEP_SUMMARY
            total=$((total + 1))
            [[ "$status" == *"å·²å‘å¸ƒ"* ]] && updated=$((updated + 1))
            [[ "$status" == *"æ— éœ€æ›´æ–°"* ]] && skipped=$((skipped + 1))
            [[ "$status" == *"å¤±è´¥"* ]] && failed=$((failed + 1))
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç»Ÿè®¡:** æ€»è®¡ $total | å·²å‘å¸ƒ $updated | æ— éœ€æ›´æ–° $skipped | å¤±è´¥ $failed" >> $GITHUB_STEP_SUMMARY
          echo "**å¹³å°:** GitCode, Gitee, GitLab, R2" >> $GITHUB_STEP_SUMMARY
      
      - uses: geekyeggo/delete-artifact@v5
        if: always()
        with:
          name: |
            status-*
            version-*
          failOnError: false
