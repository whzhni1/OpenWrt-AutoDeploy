name: 同步文件到镜像

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'auto-update.sh'
      - 'auto-setup'
      - 'auto-setup-fetch'

env:
  USERNAME: whzhni

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: 检测变更文件
        id: changed
        run: |
          changed_files=""
          for file in auto-update.sh auto-setup auto-setup-fetch; do
            if git diff --name-only HEAD~1 HEAD 2>/dev/null | grep -q "^${file}$" || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
              changed_files="$changed_files $file"
              echo "✓ 检测到: $file"
            fi
          done
          
          # 手动触发时同步所有文件
          [ "${{ github.event_name }}" = "workflow_dispatch" ] && changed_files="auto-update.sh auto-setup auto-setup-fetch"
          
          echo "files=${changed_files## }" >> $GITHUB_OUTPUT
          [ -n "$changed_files" ] && echo "has_changes=true" >> $GITHUB_OUTPUT || echo "has_changes=false" >> $GITHUB_OUTPUT

      - name: 上传到 R2
        if: steps.changed.outputs.has_changes == 'true'
        env:
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
          R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
        run: |
          export AWS_ACCESS_KEY_ID="$R2_ACCESS_KEY"
          export AWS_SECRET_ACCESS_KEY="$R2_SECRET_KEY"
          export AWS_ENDPOINT_URL="https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com"
          
          for file in ${{ steps.changed.outputs.files }}; do
            echo ">>> 上传 $file 到 R2"
            aws s3 cp "$file" "s3://openwrt-autodeploy/$file" --endpoint-url "$AWS_ENDPOINT_URL" && echo "✓ $file"
          done

      - name: 同步到镜像仓库
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: |
          REPO="${{ github.event.repository.name }}"
          USER="${{ env.USERNAME }}"
          
          sync_to() {
            echo ">>> 同步到 $1"
            git clone --depth 1 -b main "$2" _sync 2>/dev/null || {
              mkdir _sync && cd _sync && git init -b main && git remote add origin "$2" && cd ..
            }
            rsync -av --delete --exclude='.git' --exclude='.github' --exclude='_sync' ./ _sync/
            cd _sync
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add -A
            git diff --staged --quiet || { git commit -m "同步仓库"; git push origin main -f; }
            cd .. && rm -rf _sync
          }
          
          sync_to "Gitee" "https://oauth2:${GITEE_TOKEN}@gitee.com/${USER}/${REPO}.git"
          sync_to "GitCode" "https://oauth2:${GITCODE_TOKEN}@gitcode.com/${USER}/${REPO}.git"
          sync_to "GitLab" "https://oauth2:${GITLAB_TOKEN}@gitlab.com/${USER}/${REPO}.git"
