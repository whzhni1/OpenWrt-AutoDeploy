name: æµ‹è¯• Release è„šæœ¬

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'æ‰§è¡Œæ“ä½œ'
        required: true
        type: choice
        options:
          - 'åˆ›å»ºRelease'
          - 'åˆ é™¤ä»“åº“'
        default: 'åˆ›å»ºRelease'
      
      platform:
        description: 'æµ‹è¯•å¹³å°'
        required: true
        type: choice
        options:
          - 'all'
          - 'gitcode'
          - 'gitee'
          - 'gitlab'
          - 'Cloudflare R2'
        default: 'all'
      
      USERNAME:
        description: 'ç”¨æˆ·å'
        required: true
        default: 'whzhni'
      
      Project_Name:
        description: 'é¡¹ç›®å'
        required: true
        default: 'test-release'
      
      tag_name:
        description: 'Release æ ‡ç­¾å'
        required: true
        default: 'v1.0.0-test'
      
      release_title:
        description: 'Release æ ‡é¢˜'
        required: true
        default: 'æµ‹è¯• Release'
      
      enable_version_write:
        description: 'å†™å…¥ç‰ˆæœ¬åˆ° version-manager.sh'
        type: boolean
        default: false

env:
  USERNAME: ${{ github.event.inputs.USERNAME }}
  REPO_NAME: ${{ github.event.inputs.Project_Name }}
  TAG_NAME: ${{ github.event.inputs.tag_name }}
  RELEASE_TITLE: ${{ github.event.inputs.release_title }}

jobs:
  test-release:
    runs-on: ubuntu-latest
    name: ${{ github.event.inputs.action }} - ${{ github.event.inputs.platform }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: åˆ›å»ºæµ‹è¯•æ–‡ä»¶
        if: github.event.inputs.action == 'åˆ›å»ºRelease'
        run: |
          echo "æž„å»ºæ—¶é—´: $(date)" > build-time.txt
          echo "ç‰ˆæœ¬: ${{ env.TAG_NAME }}" > version.txt
          echo "# æµ‹è¯• Release æ–‡ä»¶" > README.md
          echo "æµ‹è¯•å¹³å°: ${{ github.event.inputs.platform }}" >> README.md
      
      - name: å†™å…¥ç‰ˆæœ¬ä¿¡æ¯
        if: github.event.inputs.action == 'åˆ›å»ºRelease' && github.event.inputs.enable_version_write == 'true'
        run: |
          chmod +x .github/workflows/scripts/version-manager.sh
          .github/workflows/scripts/version-manager.sh set "${{ env.TAG_NAME }}"
      
      - name: åˆ›å»º Release
        if: github.event.inputs.action == 'åˆ›å»ºRelease'
        env:
          # å¹³å°é€‰æ‹©
          PLATFORMS: ${{ github.event.inputs.platform == 'all' && 'gitcode gitee gitlab r2' || github.event.inputs.platform }}
          
          # Tokens
          GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
          R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
          
          # Release ä¿¡æ¯
          RELEASE_BODY: "## ðŸ§ª æµ‹è¯• Release\n\nå¹³å°: ${{ github.event.inputs.platform }}"
          UPLOAD_FILES: "build-time.txt version.txt README.md"
          BRANCH: main
        run: .github/workflows/scripts/release.sh
      
      - name: åˆ é™¤ä»“åº“
        if: github.event.inputs.action == 'åˆ é™¤ä»“åº“'
        env:
          GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
          R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
          PLATFORMS: ${{ github.event.inputs.platform == 'all' && 'gitcode gitee gitlab r2' || github.event.inputs.platform }}
        run: |
         chmod +x .github/workflows/scripts/delete-repo.sh
         .github/workflows/scripts/delete-repo.sh
      
      - name: ç”ŸæˆæŠ¥å‘Š
        if: always()
        run: |
          echo "# ðŸ“Š æµ‹è¯•ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **æ“ä½œ**: ${{ github.event.inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å¹³å°**: ${{ github.event.inputs.platform }}" >> $GITHUB_STEP_SUMMARY
          echo "- **é¡¹ç›®**: ${{ env.USERNAME }}/${{ env.REPO_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ ‡ç­¾**: ${{ env.TAG_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **çŠ¶æ€**: ${{ job.status == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }}" >> $GITHUB_STEP_SUMMARY
