name: æµ‹è¯• Release è„šæœ¬

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'æ‰§è¡Œæ“ä½œ'
        required: true
        type: choice
        options:
          - 'åˆ›å»ºRelease'
          - 'åˆ é™¤ä»“åº“'
        default: 'åˆ›å»ºRelease'
      
      platform_gitcode:
        description: 'ðŸ“¦ GitCode'
        type: boolean
        default: true
      
      platform_gitee:
        description: 'ðŸ“¦ Gitee'
        type: boolean
        default: true
      
      platform_gitlab:
        description: 'ðŸ“¦ GitLab'
        type: boolean
        default: true
      
      platform_r2:
        description: 'ðŸ“¦ Cloudflare R2'
        type: boolean
        default: true
      
      USERNAME:
        description: 'ç”¨æˆ·å'
        required: true
        default: 'whzhni'
      
      Project_Name:
        description: 'é¡¹ç›®å'
        required: true
        default: 'test-release'
      
      tag_name:
        description: 'Release æ ‡ç­¾å'
        required: true
        default: 'v1.0.0-test'
      
      release_title:
        description: 'Release æ ‡é¢˜'
        required: true
        default: 'æµ‹è¯• Release'
      
      enable_version_write:
        description: 'å†™å…¥ç‰ˆæœ¬åˆ° version.txt'
        type: boolean
        default: false

env:
  USERNAME: ${{ github.event.inputs.USERNAME }}
  REPO_NAME: ${{ github.event.inputs.Project_Name }}
  TAG_NAME: ${{ github.event.inputs.tag_name }}
  RELEASE_TITLE: ${{ github.event.inputs.release_title }}

jobs:
  test-release:
    runs-on: ubuntu-latest
    name: ${{ github.event.inputs.action }}
    
    steps:
      - uses: actions/checkout@v4
      - name: è¯»å– R2 é…ç½®
        id: r2-config
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          
          R2_PUBLIC_URL=$(yq eval '.defaults.R2_PUBLIC_URL' config/sync-config.yaml)
          echo "url=$R2_PUBLIC_URL" >> $GITHUB_OUTPUT
          echo "ðŸ“¡ R2_PUBLIC_URL: $R2_PUBLIC_URL"
          
      - name: æž„å»ºå¹³å°åˆ—è¡¨
        id: platforms
        run: |
          platforms=""
          [ "${{ github.event.inputs.platform_gitcode }}" = "true" ] && platforms="$platforms gitcode"
          [ "${{ github.event.inputs.platform_gitee }}" = "true" ] && platforms="$platforms gitee"
          [ "${{ github.event.inputs.platform_gitlab }}" = "true" ] && platforms="$platforms gitlab"
          [ "${{ github.event.inputs.platform_r2 }}" = "true" ] && platforms="$platforms r2"
          
          platforms="${platforms## }"
          platforms="${platforms%% }"
          
          if [ -z "$platforms" ]; then
            echo "âŒ é”™è¯¯: è‡³å°‘é€‰æ‹©ä¸€ä¸ªå¹³å°"
            exit 1
          fi
          
          echo "platforms=$platforms" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ é€‰æ‹©çš„å¹³å°: $platforms"
      
      - name: åˆ›å»ºæµ‹è¯•æ–‡ä»¶
        if: github.event.inputs.action == 'åˆ›å»ºRelease'
        run: |
          echo "æž„å»ºæ—¶é—´: $(date)" > build-time.txt
          echo "ç‰ˆæœ¬: ${{ env.TAG_NAME }}" > version.txt
          echo "# æµ‹è¯• Release æ–‡ä»¶" > README.md
          echo "" >> README.md
          echo "**æµ‹è¯•å¹³å°:**" >> README.md
          [ "${{ github.event.inputs.platform_gitcode }}" = "true" ] && echo "- âœ… GitCode" >> README.md
          [ "${{ github.event.inputs.platform_gitee }}" = "true" ] && echo "- âœ… Gitee" >> README.md
          [ "${{ github.event.inputs.platform_gitlab }}" = "true" ] && echo "- âœ… GitLab" >> README.md
          [ "${{ github.event.inputs.platform_r2 }}" = "true" ] && echo "- âœ… Cloudflare R2" >> README.md
      
      - name: å†™å…¥ç‰ˆæœ¬ä¿¡æ¯
        if: github.event.inputs.action == 'åˆ›å»ºRelease' && github.event.inputs.enable_version_write == 'true'
        run: bash .github/workflows/scripts/version-manager.sh write "${{ env.REPO_NAME }}" "${{ env.TAG_NAME }}"
      
      - name: åˆ›å»º Release
        if: github.event.inputs.action == 'åˆ›å»ºRelease'
        env:
          PLATFORMS: ${{ steps.platforms.outputs.platforms }}
          GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
          R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
          R2_PUBLIC_URL: ${{ secrets.R2_PUBLIC_URL }}
          DOWNLOAD_DIR: ${{ github.workspace }}
          GITHUB_REPO_URL: ${{ github.server_url }}/${{ github.repository }}
        run: |
          export UPLOAD_FILES="build-time.txt version.txt README.md"
          export RELEASE_BODY="## ðŸ§ª æµ‹è¯• Release

          ### ðŸ“Œ æµ‹è¯•ä¿¡æ¯
          - é¡¹ç›®: ${{ env.USERNAME }}/${{ env.REPO_NAME }}
          - ç‰ˆæœ¬: ${{ env.TAG_NAME }}
          - å¹³å°: ${{ steps.platforms.outputs.platforms }}
          - æ—¶é—´: $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')
          
          ### ðŸ“¦ æµ‹è¯•æ–‡ä»¶
          - build-time.txt
          - version.txt
          - README.md"
          
          bash .github/workflows/scripts/release.sh
      
      - name: åˆ é™¤ä»“åº“
        if: github.event.inputs.action == 'åˆ é™¤ä»“åº“'
        env:
          GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
          R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
          PLATFORMS: ${{ steps.platforms.outputs.platforms }}
        run: bash .github/workflows/scripts/delete-repo.sh
      
      - name: ç”ŸæˆæŠ¥å‘Š
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          # ðŸ“Š æµ‹è¯•ç»“æžœ
          
          | é¡¹ç›® | å€¼ |
          |------|-----|
          | æ“ä½œ | ${{ github.event.inputs.action }} |
          | é¡¹ç›® | \`${{ env.USERNAME }}/${{ env.REPO_NAME }}\` |
          | æ ‡ç­¾ | \`${{ env.TAG_NAME }}\` |
          | çŠ¶æ€ | ${{ job.status == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} |
          
          ## ðŸ“¦ æµ‹è¯•å¹³å°
          
          | å¹³å° | é€‰æ‹© |
          |------|------|
          | GitCode | ${{ github.event.inputs.platform_gitcode == 'true' && 'âœ…' || 'â¬œ' }} |
          | Gitee | ${{ github.event.inputs.platform_gitee == 'true' && 'âœ…' || 'â¬œ' }} |
          | GitLab | ${{ github.event.inputs.platform_gitlab == 'true' && 'âœ…' || 'â¬œ' }} |
          | Cloudflare R2 | ${{ github.event.inputs.platform_r2 == 'true' && 'âœ…' || 'â¬œ' }} |
          EOF
