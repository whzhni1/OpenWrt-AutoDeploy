name: ÊâìÂåÖ OpenWrt ËΩØ‰ª∂ÂåÖ

on:
  workflow_dispatch:
    inputs:
      projects:
        description: 'ÊåáÂÆöÈ°πÁõÆÔºàÈÄóÂè∑ÂàÜÈöîÔºåÁïôÁ©∫ÂÖ®ÈÉ®Ôºâ'
        required: false
      force:
        description: 'Âº∫Âà∂ÈáçÊñ∞ÊâìÂåÖ'
        type: boolean
        default: false
  schedule:
    - cron: '0 2 * * *'

env:
  CONFIG_FILE: config/dabao_config.yaml

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ÂÆâË£Ö‰æùËµñ
        run: |
          sudo apt-get update
          sudo apt-get install -y upx-ucl
          git clone --depth 1 https://github.com/openwrt/luci.git /tmp/luci
          make -C /tmp/luci/modules/luci-base/src po2lmo
          sudo cp /tmp/luci/modules/luci-base/src/po2lmo /usr/local/bin/
          chmod +x .github/workflows/scripts/*.sh

      - name: Â§ÑÁêÜÈ°πÁõÆ
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
          R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
          INPUT_PROJECTS: ${{ inputs.projects }}
          FORCE_BUILD: ${{ inputs.force }}
        run: |
          # ËØªÂèñÈÖçÁΩÆÂáΩÊï∞
          cfg() { yq e ".projects.$1.$2 // \"\"" "$CONFIG_FILE"; }
          cfg_arr() { yq e ".projects.$1.$2 // [] | .[]" "$CONFIG_FILE" | tr '\n' ' '; }
          cfg_def() { yq e ".projects.$1.$2 // .defaults.$2 // \"$3\"" "$CONFIG_FILE"; }
          def() { yq e ".defaults.$1 // \"\"" "$CONFIG_FILE"; }
          
          # Ëé∑ÂèñÈ°πÁõÆÂàóË°®
          PROJECTS=$(yq e '.projects | keys | .[]' "$CONFIG_FILE")
          
          if [ -n "$INPUT_PROJECTS" ]; then
            FILTER_PATTERN=$(echo "$INPUT_PROJECTS" | tr ',' '|')
            PROJECTS=$(echo "$PROJECTS" | grep -E "^($FILTER_PATTERN)$" || true)
          fi
          
          for proj in $PROJECTS; do
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "üì¶ $proj"
            
            REPO=$(cfg $proj repo)
            LOCAL_NAME=$(cfg $proj local_name)
            LOCAL_NAME=${LOCAL_NAME:-$proj}
            
            # Ëé∑Âèñ‰∏äÊ∏∏ÁâàÊú¨
            LATEST=$(gh api repos/$REPO/releases/latest --jq '.tag_name' 2>/dev/null || echo "")
            [ -z "$LATEST" ] && echo "‚ö†Ô∏è Ëé∑ÂèñÁâàÊú¨Â§±Ë¥•" && continue
            
            # Ê£ÄÊü•ÁâàÊú¨
            CURRENT=$(.github/workflows/scripts/version-manager.sh read "$LOCAL_NAME" 2>/dev/null || echo "")
            LATEST_CLEAN="${LATEST#v}"
            CURRENT_CLEAN="${CURRENT#v}"
            
            if [ "$FORCE_BUILD" != "true" ] && [ "$LATEST_CLEAN" = "$CURRENT_CLEAN" ]; then
              echo "‚è≠Ô∏è Â∑≤ÊúÄÊñ∞ $CURRENT"
              continue
            fi
            
            [ "$FORCE_BUILD" = "true" ] && echo "üîß Âº∫Âà∂ÊâìÂåÖ"
            echo "üîÑ $CURRENT ‚Üí $LATEST"
            
            # ‰∏ãËΩΩ
            FILTER=$(cfg $proj filter)
            rm -rf downloads/$proj bins/$proj output
            mkdir -p downloads/$proj bins/$proj output
            
            echo "üì• ‰∏ãËΩΩÊñá‰ª∂ (filter: $FILTER)"
            
            gh api repos/$REPO/releases/latest --jq '.assets[].browser_download_url' | while read url; do
              name=$(basename "$url")
              [[ "$name" != $FILTER ]] && continue
              
              skip=false
              for ex in $(cfg_arr $proj exclude); do
                [[ "$name" == $ex ]] && skip=true && break
              done
              [ "$skip" = "true" ] && continue
              
              echo "  ‚¨áÔ∏è $name"
              curl -sL "$url" -o "downloads/$proj/$name"
            done
            
            echo "üìÇ ‰∏ãËΩΩÂÆåÊàê:"
            ls -la downloads/$proj/ || echo "  (Á©∫)"
            
            # Ëß£ÂéãÊèêÂèñ‰∫åËøõÂà∂
            BIN_FILE=$(cfg $proj bin_file)
            echo "üì¶ Ëß£ÂéãÊñá‰ª∂ (bin_file: $BIN_FILE)"
            
            for f in downloads/$proj/*; do
              [ -f "$f" ] || continue
              echo "  Ëß£Âéã: $(basename "$f")"
              tmp=$(mktemp -d)
              
              case "$f" in
                *.tar.gz|*.tgz) tar -xzf "$f" -C "$tmp" ;;
                *.tar.xz) tar -xJf "$f" -C "$tmp" ;;
                *.zip) unzip -q "$f" -d "$tmp" ;;
                *.gz) gunzip -c "$f" > "$tmp/$(basename "${f%.gz}")" ;;
                *) cp "$f" "$tmp/" ;;
              esac
              
              if [ -n "$BIN_FILE" ]; then
                bin=$(find "$tmp" -name "$BIN_FILE" -type f | head -1)
              else
                bin=$(find "$tmp" -type f -executable | head -1)
              fi
              
              if [ -n "$bin" ]; then
                out=$(basename "$f" | sed 's/\.\(tar\.gz\|tgz\|tar\.xz\|zip\|gz\)$//')
                echo "  ÊèêÂèñ: $bin -> bins/$proj/$out"
                cp "$bin" "bins/$proj/$out"
                chmod +x "bins/$proj/$out"
              else
                echo "  ‚ö†Ô∏è Êú™ÊâæÂà∞‰∫åËøõÂà∂Êñá‰ª∂"
              fi
              rm -rf "$tmp"
            done
            
            echo "üìÇ ‰∫åËøõÂà∂Êñá‰ª∂:"
            ls -la bins/$proj/ || echo "  (Á©∫)"
            
            # ÊãâÂèñ LuCI
            LUCI_REPO=$(cfg $proj luci_repo)
            LUCI_DIR=""
            if [ -n "$LUCI_REPO" ]; then
              echo "üì• ÊãâÂèñ LuCI: $LUCI_REPO"
              rm -rf luci/$proj
              git clone --depth 1 "https://github.com/$LUCI_REPO.git" "luci/$proj"
              LUCI_DIR=$(find "luci/$proj" -maxdepth 1 -type d -name "luci-app-*" | head -1)
              [ -z "$LUCI_DIR" ] && LUCI_DIR="luci/$proj"
              echo "  LuCI ÁõÆÂΩï: $LUCI_DIR"
              ls -la "$LUCI_DIR/" || true
            fi
            
            # ËÆæÁΩÆÁéØÂ¢ÉÂèòÈáè
            export PKG_DEPS="$(cfg_arr $proj deps)"
            export PKG_CONFIGS="$(cfg_arr $proj configs)"
            export PKG_UPX="$(cfg_def $proj upx true)"
            export BIN_NAME="$(cfg $proj bin_name)"
            export LUCI_LANGS="$(cfg_arr $proj luci_langs)"
            export EXTRA_FILES=""
            
            if [ -d "files/$proj" ]; then
              for f in files/$proj/*; do
                [ -f "$f" ] || continue
                svc_name="${BIN_NAME:-$proj}"
                case "$f" in
                  *.init) EXTRA_FILES="$EXTRA_FILES $f:/etc/init.d/$svc_name" ;;
                  *.config) EXTRA_FILES="$EXTRA_FILES $f:/etc/config/$svc_name" ;;
                esac
              done
              export EXTRA_FILES
            fi
            
            echo "üîß ÁéØÂ¢ÉÂèòÈáè:"
            echo "  PKG_DEPS: $PKG_DEPS"
            echo "  PKG_CONFIGS: $PKG_CONFIGS"
            echo "  PKG_UPX: $PKG_UPX"
            echo "  BIN_NAME: $BIN_NAME"
            echo "  LUCI_LANGS: $LUCI_LANGS"
            echo "  EXTRA_FILES: $EXTRA_FILES"
            
            # ÊâìÂåÖ
            .github/workflows/scripts/dabao.sh "$proj" "$LATEST" "bins/$proj" "$LUCI_DIR"
            
            # ÂèëÂ∏É
            export REPO_NAME="$LOCAL_NAME"
            export TAG_NAME="$LATEST"
            export DOWNLOAD_DIR="output"
            export PLATFORMS="$(cfg_def $proj platforms "$(def platforms)")"
            export R2_PUBLIC_URL="$(def R2_PUBLIC_URL)"
            .github/workflows/scripts/release.sh
            
            # ‰øùÂ≠òÁâàÊú¨
            .github/workflows/scripts/version-manager.sh write "$LOCAL_NAME" "$LATEST"
            
            rm -rf downloads/$proj bins/$proj luci/$proj
            
            echo "‚úÖ $proj ÂÆåÊàê"
          done
