name: ÊâìÂåÖ OpenWrt ËΩØ‰ª∂ÂåÖ

on:
  workflow_dispatch:
    inputs:
      projects:
        description: 'ÊåáÂÆöÈ°πÁõÆÔºàÈÄóÂè∑ÂàÜÈöîÔºåÁïôÁ©∫ÂÖ®ÈÉ®Ôºâ'
        required: false
      force:
        description: 'Âº∫Âà∂ÈáçÊñ∞ÊâìÂåÖ'
        type: boolean
        default: false
  schedule:
    - cron: '0 2 * * *'

env:
  CONFIG_FILE: config/dabao_config.yaml

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.result }}
    steps:
      - uses: actions/checkout@v4
      
      - name: ÁîüÊàêÁü©Èòµ
        id: matrix
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          INPUT_PROJECTS: ${{ inputs.projects }}
          FORCE_BUILD: ${{ inputs.force }}
        run: |
          chmod +x .github/workflows/scripts/*.sh
          
          PROJECTS=$(yq e '.projects | keys | .[]' "$CONFIG_FILE")
          
          if [ -n "$INPUT_PROJECTS" ]; then
            FILTER_PATTERN=$(echo "$INPUT_PROJECTS" | tr ',' '|')
            PROJECTS=$(echo "$PROJECTS" | grep -E "^($FILTER_PATTERN)$" || true)
          fi
          
          MATRIX="["
          first=true
          
          for proj in $PROJECTS; do
            REPO=$(yq e ".projects.$proj.repo" "$CONFIG_FILE")
            LOCAL_NAME=$(yq e ".projects.$proj.local_name // \"\"" "$CONFIG_FILE")
            VERSION_NAME="${LOCAL_NAME:-$proj}"
            
            LATEST=$(gh api repos/$REPO/releases/latest --jq '.tag_name' 2>/dev/null || echo "")
            [ -z "$LATEST" ] && continue
            
            CURRENT=$(.github/workflows/scripts/version-manager.sh read "$VERSION_NAME" 2>/dev/null || echo "")
            LATEST_CLEAN="${LATEST#v}"
            CURRENT_CLEAN="${CURRENT#v}"
            
            if [ "$FORCE_BUILD" != "true" ] && [ "$LATEST_CLEAN" = "$CURRENT_CLEAN" ]; then
              echo "‚è≠Ô∏è $proj Â∑≤ÊúÄÊñ∞ $CURRENT"
              continue
            fi
            
            echo "‚úÖ $proj: $CURRENT ‚Üí $LATEST"
            
            LUCI_REPO=$(yq e ".projects.$proj.luci_repo // \"\"" "$CONFIG_FILE")
            
            [ "$first" = "true" ] && first=false || MATRIX="$MATRIX,"
            MATRIX="$MATRIX{\"project\":\"$proj\",\"version\":\"$LATEST\",\"has_luci\":\"$([ -n \"$LUCI_REPO\" ] && echo true || echo false)\"}"
          done
          
          MATRIX="$MATRIX]"
          echo "result=$MATRIX" >> $GITHUB_OUTPUT

  # ‰∫åËøõÂà∂ÊâìÂåÖ
  build_bin:
    needs: prepare
    if: needs.prepare.outputs.matrix != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        include: ${{ fromJSON(needs.prepare.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4

      - name: ÂÆâË£Ö‰æùËµñ
        run: |
          sudo apt-get update
          sudo apt-get install -y upx-ucl
          chmod +x .github/workflows/scripts/*.sh

      - name: ËØªÂèñÈÖçÁΩÆ
        id: config
        run: |
          proj="${{ matrix.project }}"
          
          cfg() { yq e ".projects.$proj.$1 // \"\"" "$CONFIG_FILE"; }
          cfg_arr() { yq e ".projects.$proj.$1 // [] | .[]" "$CONFIG_FILE" | tr '\n' ' '; }
          cfg_def() { yq e ".projects.$proj.$1 // .defaults.$1 // \"$2\"" "$CONFIG_FILE"; }
          
          echo "repo=$(cfg repo)" >> $GITHUB_OUTPUT
          echo "local_name=$(cfg local_name)" >> $GITHUB_OUTPUT
          echo "bin_file=$(cfg bin_file)" >> $GITHUB_OUTPUT
          echo "filter=$(cfg filter)" >> $GITHUB_OUTPUT
          echo "deps=$(cfg_arr deps)" >> $GITHUB_OUTPUT
          echo "upx=$(cfg_def upx true)" >> $GITHUB_OUTPUT

      - name: ‰∏ãËΩΩÂπ∂Â§ÑÁêÜ‰∫åËøõÂà∂
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          proj="${{ matrix.project }}"
          REPO="${{ steps.config.outputs.repo }}"
          FILTER="${{ steps.config.outputs.filter }}"
          BIN_FILE="${{ steps.config.outputs.bin_file }}"
          
          cfg_arr() { yq e ".projects.$proj.$1 // [] | .[]" "$CONFIG_FILE" | tr '\n' ' '; }
          
          mkdir -p downloads bins output
          
          echo "üì• ‰∏ãËΩΩ"
          while read url; do
            name=$(basename "$url")
            case "$name" in $FILTER) ;; *) continue ;; esac
            
            skip=false
            for ex in $(cfg_arr exclude); do
              case "$name" in $ex) skip=true; break ;; esac
            done
            [ "$skip" = "true" ] && continue
            
            echo "  ‚¨áÔ∏è $name"
            curl -sL "$url" -o "downloads/$name"
          done < <(gh api repos/$REPO/releases/latest --jq '.assets[].browser_download_url')
          
          echo "üì¶ Ëß£Âéã"
          for f in downloads/*; do
            [ -f "$f" ] || continue
            tmp=$(mktemp -d)
            
            case "$f" in
              *.tar.gz|*.tgz) tar -xzf "$f" -C "$tmp" ;;
              *.tar.xz) tar -xJf "$f" -C "$tmp" ;;
              *.zip) unzip -q "$f" -d "$tmp" ;;
              *.gz) gunzip -c "$f" > "$tmp/$(basename "${f%.gz}")" ;;
              *) cp "$f" "$tmp/" ;;
            esac
            
            bin=$([ -n "$BIN_FILE" ] && find "$tmp" -name "$BIN_FILE" -type f | head -1 || find "$tmp" -type f -executable | head -1)
            
            if [ -n "$bin" ]; then
              out=$(basename "$f" | sed 's/\.\(tar\.gz\|tgz\|tar\.xz\|zip\|gz\)$//')
              cp "$bin" "bins/$out"
              chmod +x "bins/$out"
              echo "  ‚úÖ $out"
            fi
            rm -rf "$tmp"
          done

      - name: ÊâìÂåÖ‰∫åËøõÂà∂
        run: |
          export PKG_DEPS="${{ steps.config.outputs.deps }}"
          export PKG_UPX="${{ steps.config.outputs.upx }}"
          export BIN_FILE="${{ steps.config.outputs.bin_file }}"
          export LOCAL_NAME="${{ steps.config.outputs.local_name }}"
          
          .github/workflows/scripts/dabao.sh "${{ matrix.project }}" "${{ matrix.version }}" bins

      - name: ‰∏ä‰º†‰∫ßÁâ©
        uses: actions/upload-artifact@v4
        with:
          name: bin-${{ matrix.project }}
          path: output/*

  # LuCI ÁºñËØë
  build_luci:
    needs: prepare
    if: needs.prepare.outputs.matrix != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        include: ${{ fromJSON(needs.prepare.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4
        if: matrix.has_luci == 'true'

      - name: ËØªÂèñÈÖçÁΩÆ
        if: matrix.has_luci == 'true'
        id: config
        run: |
          proj="${{ matrix.project }}"
          
          cfg() { yq e ".projects.$proj.$1 // \"\"" "$CONFIG_FILE"; }
          cfg_arr() { yq e ".projects.$proj.$1 // [] | .[]" "$CONFIG_FILE" | tr '\n' ' '; }
          
          LOCAL_NAME=$(cfg local_name)
          SERVICE_NAME="${LOCAL_NAME:-$proj}"
          
          echo "luci_repo=$(cfg luci_repo)" >> $GITHUB_OUTPUT
          echo "service_name=$SERVICE_NAME" >> $GITHUB_OUTPUT
          echo "configs=$(cfg_arr configs)" >> $GITHUB_OUTPUT

      - name: ÂáÜÂ§á LuCI
        if: matrix.has_luci == 'true'
        run: |
          chmod +x .github/workflows/scripts/*.sh
          
          git clone --depth 1 "https://github.com/${{ steps.config.outputs.luci_repo }}.git" luci-src
          
          LUCI_DIR=$(find luci-src -maxdepth 1 -type d -name "luci-app-*" | head -1)
          [ -z "$LUCI_DIR" ] && LUCI_DIR="luci-src"
          
          .github/workflows/scripts/patch-luci.sh "$LUCI_DIR" "${{ steps.config.outputs.service_name }}" "${{ steps.config.outputs.configs }}"

      - name: ÁºñËØë LuCI
        if: matrix.has_luci == 'true'
        uses: sbwml/openwrt-gh-action-sdk@go1.24
        env:
          ARCH: x86_64-openwrt-24.10
          FEEDNAME: luci_pkg
          PACKAGES: luci-app-*
          NO_REFRESH_CHECK: true
        with:
          feeds: |
            src-link luci_pkg ${{ github.workspace }}/luci-src

      - name: Êî∂ÈõÜÂåÖ
        if: matrix.has_luci == 'true'
        run: |
          mkdir -p output
          find bin -name "*.ipk" -exec cp {} output/ \;
          find bin -name "*.apk" -exec cp {} output/ \;
          ls -la output/

      - name: ‰∏ä‰º†‰∫ßÁâ©
        if: matrix.has_luci == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: luci-${{ matrix.project }}
          path: output/*

  # ÂêàÂπ∂ÂèëÂ∏É
  release:
    needs: [prepare, build_bin, build_luci]
    if: needs.prepare.outputs.matrix != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJSON(needs.prepare.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4

      - name: ËØªÂèñÈÖçÁΩÆ
        id: config
        run: |
          proj="${{ matrix.project }}"
          
          cfg() { yq e ".projects.$proj.$1 // \"\"" "$CONFIG_FILE"; }
          cfg_def() { yq e ".projects.$proj.$1 // .defaults.$1 // \"$2\"" "$CONFIG_FILE"; }
          def() { yq e ".defaults.$1 // \"\"" "$CONFIG_FILE"; }
          
          LOCAL_NAME=$(cfg local_name)
          
          echo "local_name=$LOCAL_NAME" >> $GITHUB_OUTPUT
          echo "platforms=$(cfg_def platforms "$(def platforms)")" >> $GITHUB_OUTPUT
          echo "r2_public_url=$(def R2_PUBLIC_URL)" >> $GITHUB_OUTPUT
          echo "username=$(def username)" >> $GITHUB_OUTPUT

      - name: ‰∏ãËΩΩ‰∫åËøõÂà∂‰∫ßÁâ©
        uses: actions/download-artifact@v4
        with:
          name: bin-${{ matrix.project }}
          path: output

      - name: ‰∏ãËΩΩ LuCI ‰∫ßÁâ©
        if: matrix.has_luci == 'true'
        uses: actions/download-artifact@v4
        with:
          name: luci-${{ matrix.project }}
          path: output

      - name: ÂèëÂ∏É
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
          R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
          REPO_NAME: ${{ steps.config.outputs.local_name || matrix.project }}
          TAG_NAME: ${{ matrix.version }}
          DOWNLOAD_DIR: output
          PLATFORMS: ${{ steps.config.outputs.platforms }}
          R2_PUBLIC_URL: ${{ steps.config.outputs.r2_public_url }}
          USERNAME: ${{ steps.config.outputs.username }}
        run: |
          chmod +x .github/workflows/scripts/*.sh
          echo "üìÅ ÂèëÂ∏ÉÂÜÖÂÆπ:"
          ls -la output/
          .github/workflows/scripts/release.sh

      - name: ‰øùÂ≠òÁâàÊú¨
        if: success()
        run: |
          LOCAL_NAME="${{ steps.config.outputs.local_name }}"
          VERSION_NAME="${LOCAL_NAME:-${{ matrix.project }}}"
          .github/workflows/scripts/version-manager.sh write "$VERSION_NAME" "${{ matrix.version }}"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git pull --rebase || true
          git add config/version.txt
          git commit -m "üì¶ ${{ matrix.project }} ‚Üí ${{ matrix.version }}" || true
          git push || true
