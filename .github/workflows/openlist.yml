name: æ„å»º OpenList

on:
  schedule:
    - cron: '0 17 * * *'
  workflow_dispatch:
    inputs:
      force_build:
        description: 'å¼ºåˆ¶é‡æ–°æ„å»º'
        type: boolean
        default: false

jobs:
  check-updates:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.value }}
      has_updates: ${{ steps.matrix.outputs.has_updates }}
      defaults: ${{ steps.read-config.outputs.defaults }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: è¯»å–å…¨å±€é…ç½®
        id: read-config
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          defaults=$(yq eval '.defaults' config/sync-config.yaml -o=json -I=0)
          echo "defaults=$defaults" >> $GITHUB_OUTPUT
          
          echo "ğŸ“‹ å…¨å±€é…ç½®:"
          echo "$defaults" | jq .
      
      - name: æ£€æŸ¥æ›´æ–°
        id: matrix
        run: |
          PROJECTS='[{"github_owner":"sbwml","github_repo":"luci-app-openlist2","local_name":"openlist2"}]'
          UPDATES='[]'
          
          while read -r proj; do
            owner=$(echo "$proj" | jq -r '.github_owner')
            repo=$(echo "$proj" | jq -r '.github_repo')
            name=$(echo "$proj" | jq -r '.local_name')
            
            latest=$(curl -s "https://api.github.com/repos/$owner/$repo/tags" | jq -r '.[0].name // empty')
            [ -z "$latest" ] && { echo "âš ï¸  $name: æ— ä¸Šæ¸¸ç‰ˆæœ¬"; continue; }
            
            local=$(bash .github/workflows/scripts/version-manager.sh read "$name" 2>/dev/null || echo "")
            
            if [ -z "$local" ] || [ "$local" != "$latest" ] || [ "${{ inputs.force_build }}" = "true" ]; then
              echo "âœ… $name: ${local:-æ–°é¡¹ç›®} â†’ $latest"
              UPDATES=$(echo "$UPDATES" | jq -c \
                --arg o "$owner" --arg r "$repo" --arg n "$name" --arg v "$latest" \
                '. += [{github_owner:$o, github_repo:$r, local_name:$n, version:$v}]')
            else
              echo "â„¹ï¸  $name: å·²æ˜¯æœ€æ–° ($latest)"
            fi
          done < <(echo "$PROJECTS" | jq -c '.[]')
          
          if [ "$UPDATES" = "[]" ]; then
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "value={\"include\":[]}" >> $GITHUB_OUTPUT
            echo "::notice::æ— éœ€æ„å»º"
          else
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "value={\"include\":$UPDATES}" >> $GITHUB_OUTPUT
          fi

  build:
    name: ${{ matrix.project.local_name }}-${{ matrix.arch }}-${{ matrix.sdk }}
    runs-on: ubuntu-latest
    needs: check-updates
    if: needs.check-updates.outputs.has_updates == 'true'
    
    strategy:
      fail-fast: false
      matrix:
        project: ${{ fromJson(needs.check-updates.outputs.matrix).include }}
        arch: [aarch64_cortex-a53, aarch64_cortex-a72, aarch64_cortex-a76, aarch64_generic, arm_cortex-a15_neon-vfpv4, arm_cortex-a5_vfpv4, arm_cortex-a7, arm_cortex-a7_neon-vfpv4, arm_cortex-a7_vfpv4, arm_cortex-a8_vfpv3, arm_cortex-a9, arm_cortex-a9_neon, arm_cortex-a9_vfpv3-d16, x86_64]
        sdk: [openwrt-24.10, SNAPSHOT]

    steps:
      - uses: actions/checkout@v4
        with:
          repository: ${{ matrix.project.github_owner }}/${{ matrix.project.github_repo }}
          ref: ${{ matrix.project.version }}
          fetch-depth: 0

      - name: é…ç½®æ„å»º
        run: |
          [ ! -f "openlist2/Makefile" ] && exit 0
          sed -i '/golang-package/a \\tGO_PKG_DEFAULT_LDFLAGS:=-w -s -extldflags "-static"' openlist2/Makefile
          [[ "${{ matrix.arch }}" != loongarch64* && "${{ matrix.arch }}" != mips64* && "${{ matrix.arch }}" != riscv64* ]] && \
            sed -i '/openlist2.init/a \\t/usr/bin/upx --lzma --best $(1)\/usr\/bin\/openlist2' openlist2/Makefile

      - name: æ„å»ºè½¯ä»¶åŒ…
        uses: sbwml/openwrt-gh-action-sdk@go1.25
        env:
          ARCH: ${{ matrix.arch }}-${{ matrix.sdk }}
          FEEDNAME: packages_ci
          PACKAGES: ${{ matrix.project.github_repo }}
          NO_REFRESH_CHECK: true

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.project.local_name }}-${{ matrix.arch }}-${{ matrix.sdk }}
          path: |
            bin/packages/${{ matrix.arch }}/packages_ci/*.apk
            bin/packages/${{ matrix.arch }}/packages_ci/*.ipk
          retention-days: 1
          if-no-files-found: warn

  release:
    name: å‘å¸ƒ ${{ matrix.project.local_name }}
    runs-on: ubuntu-latest
    needs: [check-updates, build]
    if: needs.check-updates.outputs.has_updates == 'true'
    
    strategy:
      fail-fast: false
      matrix:
        project: ${{ fromJson(needs.check-updates.outputs.matrix).include }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          pattern: ${{ matrix.project.local_name }}-*
          path: ${{ runner.temp }}/artifacts
          merge-multiple: false

      - name: æ•´ç†æ–‡ä»¶
        run: |
          RELEASE_DIR="${{ runner.temp }}/release"
          mkdir -p "$RELEASE_DIR"
          
          find "${{ runner.temp }}/artifacts" -name "${{ matrix.project.local_name }}-*" -type d | while read -r dir; do
            arch=$(basename "$dir" | sed 's/^${{ matrix.project.local_name }}-//' | sed 's/-\(openwrt-24.10\|SNAPSHOT\)$//')
            
            # IPK (_all.ipk å»é‡)
            find "$dir" -name "*.ipk" | while read -r f; do
              name=$(basename "$f")
              [[ "$name" == *_all.ipk ]] && [ -f "$RELEASE_DIR/$name" ] && continue
              cp "$f" "$RELEASE_DIR/"
            done
            
            # APK (luci-* é€šç”¨ï¼Œå…¶ä»–åŠ æ¶æ„)
            find "$dir" -name "*.apk" | while read -r f; do
              name=$(basename "$f")
              if [[ "$name" == luci-* ]]; then
                [ -f "$RELEASE_DIR/$name" ] || cp "$f" "$RELEASE_DIR/"
              else
                cp "$f" "$RELEASE_DIR/${name%.apk}_${arch}.apk"
              fi
            done
          done
          
          echo "RELEASE_DIR=$RELEASE_DIR" >> $GITHUB_ENV
          echo "ğŸ“¦ æ–‡ä»¶ç»Ÿè®¡: $(find "$RELEASE_DIR" -type f 2>/dev/null | wc -l) ä¸ª"

      - name: å¹¶è¡Œå‘å¸ƒ
        env:
          USERNAME: ${{ fromJSON(needs.check-updates.outputs.defaults).username }}
          PLATFORMS: ${{ fromJSON(needs.check-updates.outputs.defaults).platforms }}
          R2_PUBLIC_URL: ${{ fromJSON(needs.check-updates.outputs.defaults).R2_PUBLIC_URL }}
          
          GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
          R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
          
          REPO_NAME: ${{ matrix.project.local_name }}
          TAG_NAME: ${{ matrix.project.version }}
          DOWNLOAD_DIR: ${{ env.RELEASE_DIR }}
          GITHUB_REPO_URL: "https://github.com/${{ matrix.project.github_owner }}/${{ matrix.project.github_repo }}"
        run: |
          export UPLOAD_FILES="$(find "$DOWNLOAD_DIR" -type f \( -name '*.ipk' -o -name '*.apk' \) 2>/dev/null | tr '\n' ' ')"
          export RELEASE_BODY="## ğŸ“¦ ${{ matrix.project.local_name }} ${{ matrix.project.version }}

          ### ğŸ“Œ é¡¹ç›®ä¿¡æ¯
          - ä¸Šæ¸¸ä»“åº“: $GITHUB_REPO_URL
          - æ„å»ºæ—¶é—´: $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (åŒ—äº¬æ—¶é—´)
          - SDK ç‰ˆæœ¬: OpenWrt 24.10 + SNAPSHOT"
          
          echo "ğŸ“¦ å‡†å¤‡å‘å¸ƒ $(echo $UPLOAD_FILES | wc -w) ä¸ªæ–‡ä»¶"
          bash .github/workflows/scripts/release.sh

      - name: æ›´æ–°ç‰ˆæœ¬è®°å½•
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          bash .github/workflows/scripts/version-manager.sh write "${{ matrix.project.local_name }}" "${{ matrix.project.version }}"
          git add config/version.txt
          git diff --cached --quiet || {
            git commit -m "ğŸ“ ${{ matrix.project.local_name }} â†’ ${{ matrix.project.version }}"
            git pull --rebase origin ${{ github.ref_name }} || git push --force-with-lease
            git push origin ${{ github.ref_name }}
          }
