name: Upload to GitCode Release

on:
  workflow_dispatch:   # 手动触发，方便测试
  # 你也可以改成 push 标签自动触发：
  # push:
  #   tags:
  #     - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Generate test file
        run: echo "Hello GitCode Release" > demo.txt

      - name: Get upload URL
        id: geturl
        run: |
          TAG_NAME="v1.0.0"
          RESPONSE=$(curl -s \
            "https://api.gitcode.com/api/v5/repos/whzhni/test-release/releases/${TAG_NAME}/upload_url?access_token=${{ secrets.GITCODE_TOKEN }}&file_name=demo.txt")

          echo "Upload response: $RESPONSE"

          URL=$(echo "$RESPONSE" | jq -r '.url')
          AUTH=$(echo "$RESPONSE" | jq -r '.headers.Authorization')
          CONTENT_TYPE=$(echo "$RESPONSE" | jq -r '.headers."Content-Type"')

          echo "UPLOAD_URL=$URL" >> $GITHUB_ENV
          echo "UPLOAD_AUTH=$AUTH" >> $GITHUB_ENV
          echo "UPLOAD_CT=$CONTENT_TYPE" >> $GITHUB_ENV

      - name: Upload file
        run: |
          echo "Uploading to $UPLOAD_URL"
          curl -X PUT "$UPLOAD_URL" \
            -H "Content-Type: $UPLOAD_CT" \
            -H "Authorization: $UPLOAD_AUTH" \
            --data-binary @demo.txt
