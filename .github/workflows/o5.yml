name: Upload to GitCode Release

on:
  workflow_dispatch:   # 手动触发，方便测试

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Generate test file
        run: echo "Hello GitCode Release" > demo.txt

      - name: Ensure Release exists
        run: |
          TAG_NAME="v1.0.0"
          echo "=== 尝试创建 Release ==="
          curl -s -X POST https://api.gitcode.com/api/v5/repos/whzhni/test-release/releases \
            -H "Content-Type: application/json" \
            -H "PRIVATE-TOKEN: ${{ secrets.GITCODE_TOKEN }}" \
            -d "{
              \"tag_name\": \"${TAG_NAME}\",
              \"name\": \"Release ${TAG_NAME}\",
              \"body\": \"自动创建的 Release\"
            }" || true

      - name: Try multiple upload endpoints
        run: |
          TAG_NAME="v1.0.0"

          echo "=== 尝试方案 1: releases/{id}/attachments (假设 id=1) ==="
          curl -s -X POST https://api.gitcode.com/api/v5/repos/whzhni/test-release/releases/1/attachments \
            -H "PRIVATE-TOKEN: ${{ secrets.GITCODE_TOKEN }}" \
            -F "file=@demo.txt" || true

          echo "=== 尝试方案 2: releases/tags/{tag}/assets ==="
          curl -s -X POST https://api.gitcode.com/api/v5/repos/whzhni/test-release/releases/tags/${TAG_NAME}/assets \
            -H "PRIVATE-TOKEN: ${{ secrets.GITCODE_TOKEN }}" \
            -F "file=@demo.txt" || true

          echo "=== 尝试方案 3: releases/tags/{tag}/attachments ==="
          curl -s -X POST https://api.gitcode.com/api/v5/repos/whzhni/test-release/releases/tags/${TAG_NAME}/attachments \
            -H "PRIVATE-TOKEN: ${{ secrets.GITCODE_TOKEN }}" \
            -F "file=@demo.txt" || true

          echo "=== 尝试方案 4: releases/attachments (不带 id) ==="
          curl -s -X POST https://api.gitcode.com/api/v5/repos/whzhni/test-release/releases/attachments \
            -H "PRIVATE-TOKEN: ${{ secrets.GITCODE_TOKEN }}" \
            -F "file=@demo.txt" || true
