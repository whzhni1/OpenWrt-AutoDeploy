name: ç¼–è¯‘ OpenWrt è½¯ä»¶åŒ…

on:
  workflow_dispatch:
    inputs:
      projects:
        description: 'æŒ‡å®šé¡¹ç›®ï¼ˆé€—å·åˆ†éš”ï¼Œç•™ç©ºå…¨éƒ¨ï¼‰'
        required: false
      force:
        description: 'å¼ºåˆ¶é‡æ–°ç¼–è¯‘'
        type: boolean
        default: false
  schedule:
    - cron: '0 2 * * *'

env:
  CONFIG_FILE: config/compile_config.yaml

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      build_matrix: ${{ steps.gen.outputs.build_matrix }}
      release_matrix: ${{ steps.gen.outputs.release_matrix }}
    steps:
      - uses: actions/checkout@v4
      
      - name: ç”ŸæˆçŸ©é˜µ
        id: gen
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          INPUT_PROJECTS: ${{ inputs.projects }}
          FORCE_BUILD: ${{ inputs.force }}
        run: |
          chmod +x .github/workflows/scripts/*.sh
          
          PROJECTS=$(yq e '.projects | keys | .[]' "$CONFIG_FILE")
          ARCHS=$(yq e '.defaults.archs | .[]' "$CONFIG_FILE")
          SDKS=$(yq e '.defaults.sdks | .[]' "$CONFIG_FILE")
          UPX_EXCLUDE=$(yq e '.defaults.upx_exclude | .[]' "$CONFIG_FILE" 2>/dev/null | tr '\n' '|' | sed 's/|$//')
          
          [ -n "$INPUT_PROJECTS" ] && PROJECTS=$(echo "$PROJECTS" | grep -E "^($(echo "$INPUT_PROJECTS" | tr ',' '|'))$" || true)
          
          BUILD_MATRIX='{"include":['
          RELEASE_MATRIX='{"include":['
          build_first=true
          release_first=true
          
          for proj in $PROJECTS; do
            SOURCE_REPO=$(yq e ".projects.$proj.source_repo" "$CONFIG_FILE")
            LUCI_REPO=$(yq e ".projects.$proj.luci_repo // \"\"" "$CONFIG_FILE")
            UPX=$(yq e ".projects.$proj.upx // .defaults.upx // true" "$CONFIG_FILE")
            
            LATEST=$(gh api repos/$SOURCE_REPO/releases/latest --jq '.tag_name' 2>/dev/null || \
                     gh api repos/$SOURCE_REPO/tags --jq '.[0].name' 2>/dev/null || echo "")
            [ -z "$LATEST" ] && continue
            
            CURRENT=$(.github/workflows/scripts/version-manager.sh read "$proj" 2>/dev/null || echo "")
            
            if [ "$FORCE_BUILD" != "true" ] && [ "$LATEST" = "$CURRENT" ]; then
              echo "â­ï¸ $proj å·²æœ€æ–° $CURRENT"
              continue
            fi
            
            echo "âœ… $proj: $CURRENT â†’ $LATEST"
            
            # æ·»åŠ åˆ°å‘å¸ƒçŸ©é˜µ
            $release_first && release_first=false || RELEASE_MATRIX+=","
            RELEASE_MATRIX+="{\"project\":\"$proj\",\"version\":\"$LATEST\",\"source_repo\":\"$SOURCE_REPO\",\"luci_repo\":\"$LUCI_REPO\"}"
            
            # LuCI job
            if [ -n "$LUCI_REPO" ]; then
              $build_first && build_first=false || BUILD_MATRIX+=","
              BUILD_MATRIX+="{\"project\":\"$proj\",\"version\":\"$LATEST\",\"type\":\"luci\",\"arch\":\"x86_64\",\"sdk\":\"SNAPSHOT\",\"source_repo\":\"$SOURCE_REPO\",\"luci_repo\":\"$LUCI_REPO\",\"upx\":false}"
            fi
            
            # æž¶æž„åŒ… jobs
            for arch in $ARCHS; do
              arch_upx=$UPX
              [ -n "$UPX_EXCLUDE" ] && [[ "$arch" =~ ^($UPX_EXCLUDE)$ ]] && arch_upx=false
              
              for sdk in $SDKS; do
                $build_first && build_first=false || BUILD_MATRIX+=","
                BUILD_MATRIX+="{\"project\":\"$proj\",\"version\":\"$LATEST\",\"type\":\"bin\",\"arch\":\"$arch\",\"sdk\":\"$sdk\",\"source_repo\":\"$SOURCE_REPO\",\"luci_repo\":\"$LUCI_REPO\",\"upx\":$arch_upx}"
              done
            done
          done
          
          BUILD_MATRIX+=']}'
          RELEASE_MATRIX+=']}'
          
          echo "build_matrix=$BUILD_MATRIX" >> $GITHUB_OUTPUT
          echo "release_matrix=$RELEASE_MATRIX" >> $GITHUB_OUTPUT

  build:
    needs: prepare
    if: needs.prepare.outputs.build_matrix != '{"include":[]}'
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      fail-fast: false
      max-parallel: 10
      matrix: ${{ fromJSON(needs.prepare.outputs.build_matrix) }}
    
    steps:
      - uses: actions/checkout@v4

      - name: å‡†å¤‡æºç 
        id: prep
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x .github/workflows/scripts/*.sh
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“¦ ${{ matrix.project }} ${{ matrix.version }} [${{ matrix.type }}] (${{ matrix.arch }}-${{ matrix.sdk }})"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          mkdir -p feeds/packages output
          PROJ_NAME="${{ matrix.project }}"
          
          if [ -n "${{ matrix.luci_repo }}" ]; then
            git clone --depth 1 "https://github.com/${{ matrix.luci_repo }}.git" luci-repo
            
            LUCI_APP=$(find luci-repo -maxdepth 1 -type d -name "luci-app-*" | head -1)
            if [ -n "$LUCI_APP" ]; then
              PROJ_NAME=$(basename "$LUCI_APP" | sed 's/^luci-app-//')
              mv "$LUCI_APP" feeds/packages/
              [ -d "luci-repo/$PROJ_NAME" ] && mv "luci-repo/$PROJ_NAME" feeds/packages/
            fi
            rm -rf luci-repo
          fi
          
          [ ! -d "feeds/packages/$PROJ_NAME" ] && mkdir -p "feeds/packages/$PROJ_NAME"
          
          if [ "${{ matrix.type }}" = "luci" ]; then
            PACKAGES="luci-app-$PROJ_NAME"
          else
            PACKAGES="$PROJ_NAME"
            .github/workflows/scripts/process-makefile.sh "$PROJ_NAME" "${{ matrix.version }}" "${{ matrix.source_repo }}" "feeds/packages" "${{ matrix.upx }}"
          fi
          
          echo "proj_name=$PROJ_NAME" >> $GITHUB_OUTPUT
          echo "packages=$PACKAGES" >> $GITHUB_OUTPUT

      - name: ç¼–è¯‘
        id: compile
        continue-on-error: true
        uses: sbwml/openwrt-gh-action-sdk@go1.25
        env:
          ARCH: ${{ matrix.arch }}-${{ matrix.sdk }}
          FEEDNAME: packages_ci
          PACKAGES: ${{ steps.prep.outputs.packages }}
          NO_REFRESH_CHECK: true
          IGNORE_ERRORS: true

      - name: æ”¶é›†äº§ç‰©
        if: steps.compile.outcome == 'success'
        id: collect
        run: |
          mkdir -p output
          ARCH="${{ matrix.arch }}"
          PROJ="${{ steps.prep.outputs.proj_name }}"
          SDK="${{ matrix.sdk }}"
          
          if [ "$ARCH" = "riscv64_riscv64" ] && [ "$SDK" = "SNAPSHOT" ]; then
            PKG_DIR="bin/packages/riscv64_generic/packages_ci"
          else
            PKG_DIR="bin/packages/$ARCH/packages_ci"
          fi
          
          for pkg in "$PKG_DIR"/*.{ipk,apk}; do
            [ -f "$pkg" ] || continue
            filename=$(basename "$pkg")
            
            if [[ "$filename" == "$PROJ-"* ]] || [[ "$filename" == "luci-app-$PROJ-"* ]] || [[ "$filename" == "luci-i18n-$PROJ-"* ]]; then
              newname=$(echo "$filename" | sed -E "s/-r[0-9]+\./-$ARCH./")
              cp "$pkg" "output/$newname"
            fi
          done
          
          count=$(ls -1 output/ 2>/dev/null | wc -l)
          echo "count=$count" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ äº§ç‰©: $count ä¸ª"
          ls -lh output/

      - name: ä¸Šä¼ äº§ç‰©
        if: steps.collect.outputs.count != '0'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.project }}-${{ matrix.arch }}-${{ matrix.sdk }}
          path: output/
          retention-days: 1

  release:
    needs: [prepare, build]
    if: needs.prepare.outputs.release_matrix != '{"include":[]}'
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.prepare.outputs.release_matrix) }}
    
    steps:
      - uses: actions/checkout@v4

      - name: ä¸‹è½½äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          pattern: ${{ matrix.project }}-*
          path: output/
          merge-multiple: true

      - name: å‘å¸ƒ
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
          R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
        run: |
          chmod +x .github/workflows/scripts/*.sh
          
          count=$(ls -1 output/ 2>/dev/null | wc -l)
          echo "ðŸ“¦ ${{ matrix.project }} ${{ matrix.version }} å…± $count ä¸ªäº§ç‰©"
          ls -lh output/
          
          [ "$count" -eq 0 ] && echo "âš ï¸ æ— äº§ç‰©ï¼Œè·³è¿‡å‘å¸ƒ" && exit 0
          
          # èŽ·å–å®žé™…é¡¹ç›®åï¼ˆå¤„ç† luci_repo æƒ…å†µï¼‰
          PROJ_NAME="${{ matrix.project }}"
          if [ -n "${{ matrix.luci_repo }}" ]; then
            PROJ_NAME=$(basename "$(find output -name "luci-app-*" | head -1 | sed 's/.*luci-app-\([^-]*\).*/\1/')" 2>/dev/null || echo "$PROJ_NAME")
          fi
          
          export REPO_NAME="$PROJ_NAME"
          export TAG_NAME="${{ matrix.version }}"
          export DOWNLOAD_DIR="output"
          export PLATFORMS="$(yq e '.defaults.platforms | join(" ")' "$CONFIG_FILE")"
          export R2_PUBLIC_URL="$(yq e '.defaults.R2_PUBLIC_URL' "$CONFIG_FILE")"
          export USERNAME="$(yq e '.defaults.username' "$CONFIG_FILE")"
          .github/workflows/scripts/release.sh

      - name: è®°å½•ç‰ˆæœ¬
        run: |
          mkdir -p /tmp/version-info
          echo "${{ matrix.project }}|${{ matrix.version }}" > /tmp/version-info/update.txt

      - uses: actions/upload-artifact@v4
        with:
          name: version-${{ matrix.project }}
          path: /tmp/version-info/
          retention-days: 1

  summary:
    needs: release
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/checkout@v4
      
      - name: æ›´æ–°ç‰ˆæœ¬è®°å½•
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x .github/workflows/scripts/*.sh
          
          gh run download ${{ github.run_id }} -p "version-*" -D /tmp/versions 2>/dev/null || true
          
          updated=0
          for file in /tmp/versions/version-*/update.txt; do
            [ -f "$file" ] || continue
            IFS='|' read -r name version < "$file"
            [ -n "$name" ] && [ -n "$version" ] && {
              .github/workflows/scripts/version-manager.sh write "$name" "$version"
              echo "âœ… $name â†’ $version"
              ((updated++)) || true
            }
          done
          
          [ "$updated" -gt 0 ] || exit 0
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add config/version.txt
          git diff --cached --quiet || {
            git commit -m "ðŸ“ æ›´æ–°ç‰ˆæœ¬è®°å½•"
            for i in 1 2 3; do
              git pull --rebase origin main && git push && break || sleep $((i * 3))
            done
          }

      - name: æ¸…ç†
        uses: geekyeggo/delete-artifact@v5
        with:
          name: |
            version-*
            *-*-*
          failOnError: false
